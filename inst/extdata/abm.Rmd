---
title: "ABM"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    favicon: kth-logo.png
    source_code: embed
params:
  kthid: u1o2ujjd
  unit_code: KTH
  
---

```{r setup, include=FALSE}
library(flexdashboard)
library(crosstalk)
library(DT)
library(readr)
library(purrr)
library(dplyr)
library(ggplot2)
library(bibliomatrix)
library(tidyr)
library(scales)

colors_vb <- palette_kth(4)
run_unit <- params$unit_code

use_package_data <- TRUE

# Retrieve result tables to use in tabs and key indicators

if (!use_package_data) {
  df_diva <- abm_table1(unit_code = run_unit) 
  df_cit3y <- abm_table2(unit_code= run_unit)
  df_cf <- abm_table3(unit_code= run_unit)
  df_jcf <- abm_table4(unit_code= run_unit)
  df_copub <- abm_table5(unit_code= run_unit)
  unit_meta <- unit_info(unit = run_unit)
} else {
  df_diva <- pluck(abm_public_kth$units, params$unit_code, 1)
  df_cit3y <- pluck(abm_public_kth$units, params$unit_code, 2)
  df_cf <- pluck(abm_public_kth$units, params$unit_code, 3)
  df_jcf <- pluck(abm_public_kth$units, params$unit_code, 4)
  df_copub <- pluck(abm_public_kth$units, params$unit_code, 5)
  unit_meta <- filter(abm_public_kth$meta, unit_code == params$unit_code)
}

unit_label <- 
  abm_public_kth$meta %>% 
  filter(unit_code == run_unit) %>% 
  pull(unit_long_en)
```

Overview
===========================

Row {data-height=200}
---------------------
### Total publications (fractional counts)
```{r, fig.width = 4, fig.height = 1}
lastyear <- nth(names(df_diva), -3)
total_pubs <- sum(df_diva[, lastyear], na.rm = TRUE)

abm_bullet(label = "Publication (fractions)", value = total_pubs, reference = 2000)
```

### Swedish non-university copublication
```{r, fig.width = 3, fig.height = 1}
last_interval <- nth(df_copub$interval, -2)

nonuniv_share <- as.numeric(filter(df_copub, interval == last_interval)$nonuniv_share)
nonuniv_lbl <- sprintf("Swedish non-university: %d%%", round(100*nonuniv_share))
abm_waffle_pct(nonuniv_share, label = nonuniv_lbl)
```

### International copublication
```{r, fig.width = 3, fig.height = 1}
last_interval <- nth(df_copub$interval, -2)


int_share <- as.numeric(filter(df_copub, interval == last_interval)$int_share)
int_lbl <- sprintf("International: %d%%", round(100*int_share))
#int_lbl <- sprintf("%d%% of publications %s\nwere international copublications", round(100*int_share), last_interval)
abm_waffle_pct(int_share, label = int_lbl)
```

Row {data-height=200}
---------------------
### Field normalized citations

```{r, fig.width = 4, fig.height = 1}
last_interval <- nth(df_cf$interval, -2)
cf <- as.numeric(filter(df_cf, interval == last_interval)$cf)
abm_bullet(label = "Field normalized citations (Cf)", value = cf, reference = 1.0)
```

### Share Top10%
```{r, fig.width = 4, fig.height = 1}
top10_share <- as.numeric(filter(df_cf, interval == last_interval)$top10_share)
abm_bullet(label = "Share Top10% publications", value = top10_share, reference = 0.10, pct = TRUE)
```

Row {data-height=200}
---------------------
### Journal field normalized citations
```{r, fig.width = 4, fig.height = 1}
last_interval <- nth(df_jcf$interval, -2)
jcf <- as.numeric(filter(df_jcf, interval == last_interval)$jcf)
abm_bullet(label = "Field normalized journal citations (JCf)", value = jcf, reference = 1.0)
```

### Share Top20% journals
```{r, fig.width = 4, fig.height = 1}

top20_share <- as.numeric(filter(df_jcf, interval == last_interval)$top20_share)
abm_bullet(label = "Share in Top20% journals", value = top20_share, reference = 0.20, pct = TRUE)
```

Row
--------------------
### Background

The bibliometric indicators referred are based on publications registered in DiVA and published 2011 to 2017. Only publications which have been affiliated to KTH are included. This yields that publications written by a researcher before she/he was employed at KTH, and that are not affiliated to KTH, are not included in the statistics.

Statistics regarding citations and co-publishing are based on the subset of publications in DiVA that are registered in Web of Science.

### Further information

- [Guide to the Annual Bibliometric Monitoring at KTH](https://intra.kth.se/bibliometri/public/link/attachment/Guide%20to%20the%20Annual%20Bibliometric%20Monitoring%20at%20KTH.pdf)
- [Description of data, methods and indicators in KTH Annual Bibliometric Monitoring](https://intra.kth.se/bibliometri/public/link/attachment/Description%20of%20data,%20methods%20and%20indicators%20in%20KTH%20Annual%20Bibliometric%20Monitoring.pdf)
- [Formal definitions of field normalized citation indicators at KTH](https://www.kth.se/polopoly_fs/1.544479!/Formal%20definitions%20of%20field%20normalized%20citation%20indicators%20at%20KTH.pdf)
- [Information about DiVA and the registration process - Handle publications in DiVA](https://www.kth.se/en/biblioteket/publicera-analysera/hantera-publikationer)
- [President decision about the Annual Bibliometric Monitoring](https://intra.kth.se/bibliometri/public/link/attachment/Beslut%200934%20Arlig%20bibliometrisk%20uppfoljning.pdf)

Row
----------------------

### Publication data and attributions

```{r, echo=FALSE, out.height="60px"}

# embed_data <- function(path)
#   paste0("data:", mime::guess_type(path), ";base64,", base64enc::base64encode(path))
# 
# embed_file_link <- function(path, 
#   href = embed_data(path), 
#   name = basename(path),
#   text = paste("Download", name), ...) {
#   htmltools::a(text, href = href, download = name, ...)
# }
# 
# icon_download <- htmltools::tag("i", list(class = "fa fa-download"))
# icon_download <- htmltools::attachDependencies(icon_download, 
#   flexdashboard:::html_dependencies_fonts(TRUE, FALSE))
# 
# # export to xlsx format, into tempdir so we can embed a file link
# 
# # data that we want to export
# publications_kth <- abm_publications(unit_code = run_unit)
# 
# #install.packages("openxlsx")
# library(openxlsx)
# excel_file <- file.path(tempdir(), "PublList_KTH.xlsx")
# write.xlsx(publications_kth, excel_file)
# 
# embed_file_link(excel_file, 
#   title = "Download Publication List in Excel format",
#   text = icon_download, class="btn btn-primary")

```
Publication list for KTH in Excel format

Certain data included herein is derived from the Science Citation Index Expended (SCIE), Social Sciences Citation Index (SSCI), Arts & Humanities Citation Index (AHCI), Conference Proceedings Citation Index - Sciences (CPCI-S) and Conference Proceedings Citation Index - Social Sciences & Humanities (CPCI -SSH), prepared by Clarivate Analytics, Philadelphia, Pennsylvania, USA: : Â© Copyright Clarivate Analytics. 2017. All rights reserved. 


Publications in DiVA
=====================================

#### `r unit_label`

Row
---------------------

### Publication volume, fractionalized

```{r}
DT::datatable(df_diva %>% rename("WoS coverage" = "WoS_coverage",
                                 "DiVA publication type" = "Publication_Type_DiVA",
                                 "Total" = "P_frac"),
              rownames = FALSE,
              extensions = "Buttons",
              options = list(
                bPaginate = FALSE,
                pageLength = 100,
                dom = 'Bt',
                buttons = c("copy", "csv", "excel"),
                title = "ABM_publications")
              ) %>%
  formatRound(2:9, digits = 1, mark = "") %>%
  formatPercentage("WoS coverage", digits = 1)
```

Row
---------------------

### Publication volume 
```{r, fig.width=10, fig.height=5}
abm_graph_diva(df_diva)
```

### Web of Science coverage

```{r, fig.width=8, fig.height=5}
abm_graph_wos_coverage(df_diva)
```

Citation impact
=====================================

#### `r unit_label`

<!---Column {data-width=500}
------------------------------------- --->
Row
---------------------

###  Citations 3-year window, fractional counts

```{r}
DT::datatable(df_cit3y %>% rename("Publication year" = "Publication_Year_ch",
                                  "Publications" = "P_frac",
                                  "Total Citations" = "C3_frac",
                                  "Average Citations" = "C3"),
              rownames = FALSE,
              extensions = "Buttons",
              options = list(
                bPaginate = FALSE,
                dom = 'Bt',
                buttons = c("copy", "csv", "excel"),
                title = "ABM_citations")
              ) %>% 
  formatRound(2:4, digits = 1, mark = "")
```

<!--- Column {data-width=500}
------------------------------------- --->

###  Field normalized citations - Fractionalized (3-year moving average)

```{r}
DT::datatable(df_cf %>% rename("Publication years" = "interval",
                               "Publications" = "P_frac",
                               "Average Cf" = "cf",
                               "Top 10% publications" = "top10_count",
                               "Share Top 10%" = "top10_share"),
              rownames = FALSE,
              extensions = "Buttons",
              options = list(
                bPaginate = FALSE,
                dom = 'Bt',
                buttons = c("copy", "csv", "excel"),
                filename = "ABM_field_normalized_citations")
              ) %>% 
  formatRound(2:4, digits = 1, mark = "") %>% 
  formatPercentage(5, digits = 1)
```

Row
---------------------

###  Average field normalized citations (cf)

```{r}
abm_graph_cf(df_cf)
```


### %Top-10% 

```{r}
abm_graph_top10(df_cf)
```


Journal impact
=====================================

#### `r unit_label`

Row
---------------------

### 3-year moving average, fractional counts

```{r}
DT::datatable(df_jcf %>% rename("Publication years" = "interval",
                                "Publications" = "P_frac",
                                "Average Journal Cf" = "jcf",
                                "Publications in Top 20% journals" = "top20_count",
                                "Share Top 20% journals" = "top20_share"),
              rownames = FALSE,
              extensions = "Buttons",
              options = list(
                bPaginate = FALSE,
                dom = 'Bt',
                buttons = c("copy", "csv", "excel"),
                title = "ABM_journal_impact")
              ) %>% 
  formatRound(2:4, digits = 1, mark = "") %>% 
  formatPercentage(5, digits = 1)
```

Row
---------------------

###  Field normalized journal indicator

```{r}
abm_graph_jcf(df_jcf)
```


### Journal Top-20% 

```{r}
abm_graph_top20(df_jcf)
```

Co-publishing
=====================================

#### `r unit_label`

Row
---------------------

### International and Swedish non-university copublications (full counts)

```{r}
DT::datatable(df_copub %>% rename("Publication years" = "interval",
                                 "Publications" = "P_full",
                                 "Swedish non-university copublications" = "nonuniv_count",
                                 "Share Swedish non-university" = "nonuniv_share",
                                 "International copublications" = "int_count",
                                 "Share international" = "int_share"),
              rownames = FALSE,
              extensions = "Buttons",
              options = list(
                bPaginate = FALSE,
                dom = 'Bt',
                buttons = c("copy", "csv", "excel"),
                title = "ABM_copublications")
              ) %>%
  formatPercentage(c(4,6), digits = 1)
```

Row
----------------------

### International and Swedish non-university copublication

```{r, fig.width=9, fig.height=6}
abm_graph_copub(df_copub)
```

