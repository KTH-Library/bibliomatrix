---
title: "ABM"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    favicon: kth-logo.png
    fig_mobile: FALSE
params:
  unit_code: !r bibliomatrix:::abm_config()$default_unit
  is_employee: FALSE
  use_package_data: TRUE
  embed_data: FALSE
---

```{r setup, include=FALSE}
# unit_codes for testing:

# u1g9umtq
# u1jr9fll 
# u1ygqmuy
# u13bp6vd
# u18qe64m   <- NB: this one triggers an exception in sliding_intervals() fcn

library(flexdashboard)
library(DT)
library(readr)
library(purrr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(bibliomatrix)
library(tidyr)
library(scales)
library(plotly)
library(kableExtra)
library(glue)

colors_vb <- palette_kth(4)

# Retrieve result tables to use in tabs and key indicators

if (params$use_package_data != TRUE) {
  con <- pool_bib()
  df_diva <- abm_table1(con = con, unit_code = params$unit_code) 
  df_cit3y <- abm_table2(con = con, unit_code= params$unit_code)
  df_cf <- abm_table3(con = con, unit_code= params$unit_code)
  df_jcf <- abm_table4(con = con, unit_code= params$unit_code)
  df_copub <- abm_table5(con = con, unit_code= params$unit_code)
  df_woscov <- abm_woscoverage(con = con, unit_code = params$unit_code)
  unit_meta <- unit_info(con = con) %>% filter(unit_code == params$unit_code)
  pool::poolClose(con)
} else {
  df_diva <- pluck(abm_public_kth$units, params$unit_code, 1)
  df_cit3y <- pluck(abm_public_kth$units, params$unit_code, 2)
  df_cf <- pluck(abm_public_kth$units, params$unit_code, 3)
  df_jcf <- pluck(abm_public_kth$units, params$unit_code, 4)
  df_copub <- pluck(abm_public_kth$units, params$unit_code, 5)
  df_woscov <- pluck(abm_public_kth$units, params$unit_code, "coverage")
  unit_meta <- filter(abm_public_kth$meta, unit_code == params$unit_code)
}

unit_level <- abm_public_kth$meta %>% 
     filter(unit_code == params$unit_code) %>%
     pull(org_level)

if(isTRUE(unit_level >= 0)){
  
  unit_label <- 
    abm_public_kth$meta %>% 
    filter(unit_code == params$unit_code) %>%
    pull(unit_long_en)
  
} else {
  
  unit_label <- 
    ad_displayname(kthid = params$unit_code)
}



```


Overview
===========================

#### `r unit_label`

Row  {data-height=240}
---------------------

```{r}
yrfields <- grep("^[1-2][0-9]{3}$", names(df_diva))
firstyear <- min(names(df_diva[yrfields]))
lastyear <- max(names(df_diva[yrfields]))
```

### **Publications in DiVA `r lastyear`<br>(fractional counts)**

```{r, fig.width = 3, fig.height = 2}
if (nrow(df_diva) > 0) {
  
  total_pubs <- sum(df_diva[, lastyear], na.rm = TRUE)
  
  vb1 <- valueBox(
    value = round(total_pubs, 1),
    color = colors_vb[1],
    icon = "fa-chart-bar",
    href = "#publications-in-diva")
  
  vb1
}

```

### **WoS coverage `r firstyear` - `r lastyear`<br>(peer reviewed)**

```{r, fig.width = 3, fig.height = 2}
if (nrow(df_diva) > 0) {
  
  totcov <- df_woscov %>% 
    filter(Publication_Type == "Peer reviewed") %>% 
    summarise(woscov = sum(sumcov_frac) / sum(p_frac)) %>% 
    pull(woscov)
  
  vb2 <- valueBox(
    value = paste(100*round(totcov, 3), "%"),
    color = colors_vb[1],
    icon = "fa-percent",
    href = "#publications-in-diva")
  
  vb2
}

```
```{r}
has_rows <- df_cf %>% filter(!is.na(P_frac)) %>% nrow() > 0
last_interval <- ifelse(has_rows, nth(df_cf$interval, -2), "")

```

### **[Citation impact `r last_interval`](#citation-impact)** {.no-padding .no-mobile}

```{r, fig.width = 3.5, fig.height = 2}
library(patchwork)

if (has_rows == TRUE) {
  
  cf <- df_cf %>% filter(interval == last_interval) %>% pull(cf) %>% as.numeric()
  
  pub_bullet1 <- abm_bullet(label = "Field normalized citations (Cf)", 
    value = cf, reference = 1.0, roundto = 2)
  
  top10_share <- as.numeric(filter(df_cf, interval == last_interval)$top10_share)
  
  pub_bullet2 <- abm_bullet(label = "Share Top10% publications", 
    value = top10_share, reference = 0.10, pct = TRUE)
  
  #bullets <- grid.arrange(pub_bullet1, pub_bullet2, ncol = 1)
  
  bullets <- pub_bullet1 / pub_bullet2
  
  bullets
}
```

### **[Citation impact `r last_interval`](#citation-impact)** {.no-padding .mobile}

```{r, fig.width=3.75, fig.height = 2}
if (has_rows == TRUE){
   bullets
}
```

```{r}

has_rows <- df_jcf %>% filter(!is.na(P_frac)) %>% nrow() > 0
last_interval <- ifelse(has_rows, nth(df_jcf$interval, -2), "")

```
### **[Journal impact `r last_interval`](#journal-impact)**  {.no-padding .no-mobile}

```{r, fig.width=3.75, fig.height = 2} 
if (has_rows == TRUE) {
  
  jcf <- df_jcf %>% filter(interval == last_interval) %>% pull(jcf) %>% as.numeric()
  
  jour_bullet1 <- abm_bullet(label = "Field normalized journal citations (JCf)", 
    value = jcf, reference = 1.0, roundto = 2)

  top20_share <- as.numeric(filter(df_jcf, interval == last_interval)$top20_share)
  
  jour_bullet2 <- abm_bullet(label = "Share in Top20% journals", value = top20_share, 
    reference = 0.20, pct = TRUE)
  
  bullets <- jour_bullet1 / jour_bullet2
  
  bullets
}

```

### **[Journal impact `r last_interval`](#journal-impact)**  {.no-padding .mobile}

```{r, fig.width=3.75, fig.height = 2}
if (has_rows == TRUE){
  bullets
}
```


```{r}
has_rows <- df_copub %>% filter(!is.na(P_full)) %>% nrow > 0
last_interval <- nth(df_copub$interval, -2)
```

### **[Co-publishing `r last_interval`](#co-publishing)** {.no-padding .no-mobile}
```{r, fig.width = 3.75, fig.height = 2.5}

if (has_rows == TRUE) {
  
  nonuniv_share <- as.numeric(filter(df_copub, interval == last_interval)$nonuniv_share)
  nonuniv_lbl <- sprintf("Swedish non-university: %d%%", round(100 * nonuniv_share))
  waffle1 <- abm_waffle_pct(nonuniv_share, label = nonuniv_lbl) 

  int_share <- as.numeric(filter(df_copub, interval == last_interval)$int_share)
  int_lbl <- sprintf("International: %d%%", round(100*int_share))
  waffle2 <- abm_waffle_pct(int_share, label = int_lbl)

  waffles <- waffle1 / waffle2
  
  waffles
}
```

### **[Co-publishing `r last_interval`](#co-publishing)** {.no-padding .mobile}

```{r, fig.width = 3.75, fig.height = 2.5}
if (has_rows == TRUE) {
  waffles
}
```

Row
--------------------------------

### **Notes**
```{r, echo=FALSE, results="asis"}
cat("<p>Impact and co-publication indicators are based on Web of Science publications only.</p>")

if(isTRUE(unit_level >= 0)){

  glue("<p>Overall Web of Science coverage for peer reviewed publications in this unit is ",
       "{coveragetext(totcov)}, {100*round(totcov, 3)}%.</p>")

} else {

  cat("<p><b>Bibliometric results for individual researchers should always be interpreted with caution. </b></br/>
      Bibliometric indicators work best at an aggregated level, and at the individual level 
      the publication profile of researchers, their collaboration networks and their subject specialization may 
      interact with e.g. the field-normalization of citation indicators. The relatively low publication volume of 
      individuals also makes indicator averages very unreliable. </p>")

}
```

Row
--------------------------------
### **Background**

The bibliometric indicators referred are based on publications registered in DiVA and published 2012 to 2018. Only publications which have been affiliated to KTH are included. This means that publications written by a researcher before she/he was employed at KTH, and that are not affiliated to KTH, will not be included in the statistics.

Statistics regarding citations and co-publishing are based on the subset of publications in DiVA that are registered in Web of Science.

### **Further information**

```{r}
# TODO: change to suitable location for static PDF assets (or other non-HTML resources)
STATIC <- "https://kth-library.github.io/abm"
```

- [Guide to the Annual Bibliometric Monitoring at KTH](`r STATIC`/ABM_guide.pdf){target="_blank"}
- [Description of data, methods and indicators in KTH Annual Bibliometric Monitoring](`r STATIC`/Description_data_and_methods_ABM.pdf){target="_blank"}
- [Formal definitions of field normalized citation indicators at KTH](`r STATIC`/Formal_definitions_field_normalized_citation.pdf){target="_blank"}
- [Information about DiVA and the registration process - Handle publications in DiVA](https://www.kth.se/en/biblioteket/publicera-analysera/hantera-publikationer){target="_blank"}
- [President decision about the Annual Bibliometric Monitoring](`r STATIC`/Beslut_ABM.pdf){target="_blank"}

For further questions, contact the KTH Library at [biblioteket@kth.se](mailto:biblioteket@kth.se).


Row
----------------------

### **Publication data**

```{r, echo=FALSE, results="asis"}

if (params$embed_data == TRUE) {
  
  library(htmltools)
  
  embed_data <- function(path)
    paste0("data:", mime::guess_type(path), ";base64,", 
      base64enc::base64encode(path))
  
  embed_file_link <- function(path,
    href = embed_data(path),
    name = basename(path),
    text = paste("Download", name), ...) {
    withTags(p(a(text, href = href, download = name, ...)))
  }
  
  icon_download <- htmltools::tag("i", list(
    class = "fa fa-download", 
    paste("Publication data for", unit_label)))
  
  icon_download <- htmltools::attachDependencies(icon_download,
    flexdashboard:::html_dependencies_fonts(TRUE, FALSE))
  
  # export to xlsx format, into tempdir so we can embed a file link
  
  # data that we want to export
  con <- pool_bib()
  publications_kth <- abm_publications(con = con, unit_code = params$unit_code)
  pool::poolClose(con)
  
  #install.packages("openxlsx")
  library(openxlsx)
  
  # For schools, use unit_short for filename, otherwise use unit_code,
  unitname <- ifelse(isTRUE(unit_level == 1),
                     unit_info() %>% filter(unit_code == params$unit_code) %>% pull(unit_short),
                     params$unit_code)

  excel_file <- file.path(tempdir(), paste0("PublList_", unitname, ".xls"))
  
  # Create excel workbook and define and format sheets
  export_excel<- createWorkbook()
  addWorksheet(export_excel, "Data")
  addWorksheet(export_excel, "Attribution")
  attrib_style <- createStyle(wrapText = TRUE, fontSize = 13, textDecoration = "Bold")
  addStyle(export_excel, "Attribution", attrib_style, cols=1, rows=1:5)
  setColWidths(export_excel, "Attribution", cols = 1, widths = 100)
  
  # Write data to excel sheet
  writeData(export_excel, sheet = "Data", x = publications_kth)
  writeData(export_excel, sheet = "Attribution", x = wos_attribution(), colNames = FALSE)
  
  # Save excel file
  saveWorkbook(export_excel, excel_file, overwrite=TRUE)  # risky to state overwrite=TRUE?
  
  embed_file_link(excel_file,
    title = "Download Publication List in Excel format",
    text = icon_download, 
    class = "btn btn-sm btn-primary")
} else {
  cat("Publication data is available only after login.")
}
```


```{r, echo=FALSE, results="asis"}

if (params$is_employee == TRUE) {
  out <- '<a href="https://kth.diva-portal.org/dream" class="btn btn-sm btn-primary">Edit your publication data in DiVA</a><p>Please register publications in DiVA as soon as possible for these to be included in the Annual Bibliometric Monitoring.</p>'
  cat(out)
}
  
```

### **Attributions**

```{r, echo=FALSE, results="asis"}
wos_attribution()
```

Publications in DiVA
=====================================

#### `r unit_label`

Row
---------------------

### **Publication volume, fractionalized** {.no-padding .no-mobile}

<!-- <div style='width:720px;margin:auto'> -->

```{r, fig.width=3.75}
if (nrow(df_diva) > 0) {
  
  df <- df_diva %>% rename(
    "WoS coverage" = "WoS_coverage",
    "DiVA publication type" = "Publication_Type_DiVA",
    "Total" = "P_frac")
  
  dt <- 
    DT::datatable(df,
      rownames = FALSE,
      extensions = c("Buttons"), #c("Buttons", "Scroller"), 
      style = "bootstrap", class = "compact", width = "720",
      options = list(
        #deferRender = TRUE, scroller = TRUE, scrollX = TRUE,
        ordering = FALSE,
        bPaginate = FALSE,
        pageLength = 100,
        dom = 'Bt',
        buttons = list("copy", "csv", "excel"),
        title = "ABM_publications")
      ) %>%
    formatRound(2:9, digits = 1, mark = "") %>%
    formatPercentage("WoS coverage", digits = 1) %>%
    abm_format_rows()
  
  dt
}

```
<!-- </div> -->

### **Publication volume, fractionalized** {.no-padding .mobile}

```{r, fig.width=3.75}
if (nrow(df_diva) > 0) {
  df %>% 
    mutate_at(vars(starts_with("201"), starts_with("Total")), round, digits = 1) %>%
    mutate_at(vars(starts_with("WoS")), function(x) sprintf("%3.1f%%", x * 100)) %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("responsive")) %>%
    scroll_box(width = "720px")
}
```


Row
---------------------

### **Publication volume** {.no-padding .no-mobile}

```{r, fig.width=10, fig.height=10}
if (nrow(df_diva) > 0) {
  p <- abm_graph_diva(df_diva)
  p
}
```

### **Publication volume** {.no-padding .mobile}

```{r, fig.width=10, fig.height = 9.6, out.width=3.75}
if (nrow(df_diva) > 0) {
  p
}
```

### **Web of Science coverage** {.no-padding .no-mobile}

```{r, fig.width=7, fig.height=8}
if (nrow(df_diva) > 0) {
  p <- abm_graph_wos_coverage(df_diva)
  p
}
```

### **Web of Science coverage** {.no-padding .mobile}

```{r, fig.width=9, fig.height=6}
if (nrow(df_diva) > 0) {
  p
}
```


Citation impact
=====================================

#### `r unit_label`

Row
---------------------

### **Citations 3-year window, fractional counts** {.no-mobile}

```{r}
df <- df_cit3y %>% rename(
  "Publication year" = "Publication_Year_ch",
  "Publications" = "P_frac",
  "Total Citations" = "C3_frac",
  "Average Citations" = "C3"
)

if (nrow(df) > 0) {
  DT::datatable(df,
    rownames = FALSE,
    extensions = "Buttons",
    options = list(
      bPaginate = FALSE,
      dom = 'Bt',
      buttons = c("copy", "csv", "excel"),
      title = "ABM_citations")
    ) %>% 
    formatRound(2:4, digits = 1, mark = "") %>%
    abm_format_rows()
}
```

### **Citations 3-year window, fractional counts** {.mobile}

```{r}
if (nrow(df) > 0) {
  df %>% 
    mutate_at(vars(2:4), function(x) sprintf("%.1f", x)) %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("responsive")) %>%
    scroll_box(width = "720px")
}
```

### **Field normalized citations - Fractionalized (3-year moving average)** {.no-mobile}

```{r} 
df <- df_cf %>% rename(
  "Publication years" = "interval",
  "Publications" = "P_frac",
  "Average Cf" = "cf",
  "Top 10% publications" = "top10_count",
  "Share Top 10%" = "top10_share")

if (nrow(df) > 0) {
  DT::datatable(df,
    rownames = FALSE,
    extensions = "Buttons",
    options = list(
      bPaginate = FALSE,
      dom = 'Bt',
      buttons = c("copy", "csv", "excel"),
      filename = "ABM_field_normalized_citations")
    ) %>% 
    formatRound(c(2, 4), digits = 1, mark = "") %>% 
    formatRound(3, digits = 2, mark = "") %>%
    formatPercentage(5, digits = 1) %>%
    abm_format_rows()
}
```

### **Field normalized citations - Fractionalized (3-year moving average)** {.no-padding .mobile}

```{r}
if (nrow(df) > 0) {
  df %>% 
    mutate_at(vars(2, 4), function(x) sprintf("%.1f", x)) %>%
    mutate_at(vars(3), function(x) sprintf("%.2f", x)) %>%
    mutate_at(vars(5), function(x) sprintf("%.1f%%", x * 100)) %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("responsive")) %>%
    scroll_box(width = "720px")
}
```


Row
--------------------

### **Notes**
```{r, echo=FALSE, results="asis"}
cat("This table is based on Web of Science publication types Article, Proceedings paper, Review, Letter and Editorial.<br>")

if(isTRUE(unit_level >= 0)){

  years <- df_cit3y %>% filter(substr(Publication_Year_ch, 1, 1) == "2") %>% pull(Publication_Year_ch) %>% as.integer()
  mincov <- df_woscov %>% filter(Publication_Type == "Peer reviewed" & Publication_Year %in% years) %>% pull(woscov_frac) %>% min()
  minpubs <- df_woscov %>% filter(Publication_Type == "Peer reviewed" & Publication_Year %in% years) %>% pull(sumcov_full) %>% min()

  cat(glue("Rows are based on at least <b>{minpubs}</b> (full counted) publications with ",
           "<b>{coveragetext(mincov)}</b> Web of Science coverage (at worst <b>{round(100*mincov, 1)}%</b>).<br>",
           "(DiVA publication types Article, peer review and Conference paper, peer review)<br>"))

  if(minpubs < 50)
    cat("<b>Indicators based on < 50 publications are considered unreliable</b>")

} else {

  cat("<b>Bibliometric results for individual researchers should always be interpreted with caution.</b>")

}


```

### **Notes**
```{r, echo=FALSE, results="asis"}
cat("This table is based on Web of Science publication types Article and Review.<br>")

if(isTRUE(unit_level >= 0)){

  intervals <- df_cf %>% filter(substr(interval, 1, 1) == "2") %>% pull(interval)
  woscov_cf <- df_woscov %>%
    filter(Publication_Type == "Article, peer review")
  woscov_cf <- woscov_cf %>% 
    inner_join(sliding_intervals(min(woscov_cf$Publication_Year), max(woscov_cf$Publication_Year), 3), by = c("Publication_Year" = "x")) %>%
    filter(interval %in% intervals) %>%
    group_by(interval) %>% 
    summarise(woscov_frac = sum(sumcov_frac) / sum(p_frac),
              sumcov_full = sum(sumcov_full))

  mincov <- min(woscov_cf$woscov_frac)
  minpubs <- min(woscov_cf$sumcov_full)

  cat(glue("Rows are based on at least <b>{minpubs}</b> (full counted) publications with ",
           "<b>{coveragetext(mincov)}</b> Web of Science coverage (at worst <b>{round(100*mincov, 1)}%</b>).<br>",
           "(DiVA publication type Article, peer review)<br>"))

  if(minpubs < 50)
    cat("<b>Indicators based on < 50 publications are considered unreliable</b>")

} else {

  cat("<b>Bibliometric results for individual researchers should always be interpreted with caution.</b>")

}
```


Row
---------------------

### **Average field normalized citations (Cf)**

```{r}
if (df_cf %>% filter(!is.na(P_frac)) %>% nrow() > 0)
  abm_graph_cf(df_cf)
```


### **Share Top 10%**

```{r}
if (df_cf %>% filter(!is.na(P_frac)) %>% nrow() > 0)
  abm_graph_top10(df_cf)
```


Journal impact
=====================================

#### `r unit_label`

Row
---------------------

### **3-year moving average, fractional counts** {.no-mobile}

```{r}
df <- df_jcf %>% rename(
  "Publication years" = "interval",
  "Publications" = "P_frac",
  "Average Journal Cf" = "jcf",
  "Publications in Top 20% journals" = "top20_count",
  "Share Top 20% journals" = "top20_share"
)

if (nrow(df) > 0) {
  DT::datatable(df,
    rownames = FALSE,
    extensions = "Buttons",
    options = list(
      bPaginate = FALSE,
      dom = 'Bt',
      buttons = c("copy", "csv", "excel"),
      title = "ABM_journal_impact")
    ) %>% 
    formatRound(c(2, 4), digits = 1, mark = "") %>% 
    formatRound(3, digits = 2, mark = "") %>% 
    formatPercentage(5, digits = 1) %>%
    abm_format_rows()
}
```

### **3-year moving average, fractional counts** {.no-padding .mobile}

```{r, fig.width=3.75}
if (nrow(df) > 0) {
  df %>% 
    mutate_at(vars(2, 4), function(x) sprintf("%.1f", x)) %>%
    mutate_at(vars(3), function(x) sprintf("%.2f", x)) %>%
    mutate_at(vars(5), function(x) sprintf("%.1f%%", x * 100)) %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("responsive")) %>%
    scroll_box(width = "720px")
}
```



Row
-----------------

### **Notes**
```{r, echo=FALSE, results="asis"}
cat("This table is based on Web of Science publication types Article and Review.<br>")

if(isTRUE(unit_level >= 0)){
  intervals <- df_jcf %>% filter(substr(interval, 1, 1) == "2") %>% pull(interval)
  woscov_jcf <- df_woscov %>%
    filter(Publication_Type == "Article, peer review")
  woscov_jcf <- woscov_jcf %>% 
    inner_join(sliding_intervals(min(woscov_jcf$Publication_Year), max(woscov_jcf$Publication_Year), 3), by = c("Publication_Year" = "x")) %>%
    filter(interval %in% intervals) %>%
    group_by(interval) %>% 
    summarise(woscov_frac = sum(sumcov_frac) / sum(p_frac),
              sumcov_full = sum(sumcov_full))

  mincov <- min(woscov_jcf$woscov_frac)
  minpubs <- min(woscov_jcf$sumcov_full)

  cat(glue("Rows are based on at least <b>{minpubs}</b> (full counted) publications with ",
           "<b>{coveragetext(mincov)}</b> Web of Science coverage (at worst <b>{round(100*mincov, 1)}%</b>).<br>",
           "(DiVA publication type Article, peer review)<br>"))

  if(minpubs < 50)
    cat("<b>Indicators based on < 50 publications are considered unreliable</b>")

} else {

  cat("<b>Bibliometric results for individual researchers should always be interpreted with caution.</b>")

}
```

Row
---------------------

### **Field normalized journal indicator (JCf)**

```{r}
if(df_jcf %>% filter(!is.na(P_frac)) %>% nrow() > 0) {
  abm_graph_jcf(df_jcf)
}
```


### **Share Journal Top 20%**

```{r}
if(df_cf %>% filter(!is.na(P_frac)) %>% nrow() > 0) {
  abm_graph_top20(df_jcf)
}
```

Co-publishing
=====================================

#### `r unit_label`

Row
---------------------

### **International and Swedish non-university co-publications (full counts)** {.no-mobile}

```{r}
df <- df_copub %>% rename(
  "Publication years" = "interval",
  "Publications" = "P_full",
  "Swedish non-university co-publications" = "nonuniv_count",
  "Share Swedish non-university" = "nonuniv_share",
  "International co-publications" = "int_count",
  "Share international" = "int_share")

if (nrow(df) > 0) {
  DT::datatable(df,
    rownames = FALSE,
    extensions = "Buttons",
    options = list(
      bPaginate = FALSE,
      dom = 'Bt',
      buttons = c("copy", "csv", "excel"),
      title = "ABM_co-publications")
    ) %>%
    formatPercentage(c(4,6), digits = 1) %>%
    abm_format_rows()
}
```

### **International and Swedish non-university co-publications (full counts)** {.no-padding .mobile}

```{r, fig.width=3.75}
if (nrow(df) > 0) {
  df %>% 
    mutate_at(vars(4, 6), function(x) sprintf("%.1f%%", x * 100)) %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("responsive")) %>%
    scroll_box(width = "720px")
}
```


Row
-----------------

### **Notes**
```{r, echo=FALSE, results="asis"}
cat("This table is based on Web of Science publication types Article and Review.<br>")

if(isTRUE(unit_level >= 0)){
  intervals <- df_copub %>% filter(substr(interval, 1, 1) == "2") %>% pull(interval)
  woscov_copub <- df_woscov %>%
    filter(Publication_Type == "Article, peer review")
  woscov_copub <- woscov_copub %>% 
    inner_join(sliding_intervals(min(woscov_copub$Publication_Year), max(woscov_copub$Publication_Year), 3), by = c("Publication_Year" = "x")) %>%
    filter(interval %in% intervals) %>%
    group_by(interval) %>% 
    summarise(woscov_full = sum(sumcov_full) / sum(p_full))

  mincov <- min(woscov_copub$woscov_full)
  minpubs <- min(df_copub$P_full)

  cat(glue("Rows are based on at least <b>{minpubs}</b> (full counted) publications with ",
           "<b>{coveragetext(mincov)}</b> Web of Science coverage (at worst <b>{round(100*mincov, 1)}%</b>).<br>",
           "(DiVA publication type Article, peer review)<br>"))

  if(minpubs < 50)
    cat("<b>Indicators based on < 50 publications are considered unreliable</b>")

} else {

  cat("<b>Bibliometric results for individual researchers should always be interpreted with caution.</b>")

}
```

Row
-------
### **International and Swedish non-university co-publication**
```{r, fig.width=6, fig.height=4}
if(df_copub %>% filter(!is.na(P_full)) %>% nrow() > 0) {
  abm_graph_copub(df_copub)
}
```