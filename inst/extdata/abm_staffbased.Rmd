---
title: "ABM - staffbased"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    favicon: kth-logo.png
    fig_mobile: FALSE
params:
  unit_code: !r bibliomatrix:::abm_config()$default_unit
  is_employee: FALSE
  use_package_data: TRUE
  embed_data: FALSE
---
  
  
```{r setup, include=FALSE}
# unit slug for testing:

# "j/jh/jhs"
# 

library(flexdashboard)
library(DT)
library(readr)
library(purrr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(bibliomatrix)
library(tidyr)
library(scales)
#library(plotly)
library(kableExtra)
library(glue)
library(extrafont)

colors_vb <- palette_kth(4)

# Retrieve result tables to use in tabs and key indicators

# Dummy org data
unit_code<- "j/jh/jhs"  #"j/jh/jhs"
unit_members<- unit_staff(unit_slug=unit_code)
unit_publ<- abm_staff_data(kthids=unit_members$kthid)


#if (params$use_package_data != TRUE) {
  con <- pool_bib()
  df_diva <- abm_table1_alt(con = con, data=unit_publ) 
  df_cit3y <- abm_table2_alt(con = con, data=unit_publ)
  df_cf <- abm_table3_alt(con = con, data=unit_publ)
  df_jcf <- abm_table4_alt(con = con, data=unit_publ)
#  df_copub <- abm_table5(con = con, unit_code= params$unit_code)
  df_woscov <- abm_woscoverage_alt(con = con, data=unit_publ)
#  df_oa <- abm_table6(con = con, unit_code = params$unit_code)
#  unit_meta <- unit_info(con = con) %>% filter(unit_code == params$unit_code)
  pool::poolClose(con)
#} else {
#  df_diva <- pluck(abm_public_kth$units, params$unit_code, 1)
#  df_cit3y <- pluck(abm_public_kth$units, params$unit_code, 2)
#  df_cf <- pluck(abm_public_kth$units, params$unit_code, 3)
#  df_jcf <- pluck(abm_public_kth$units, params$unit_code, 4)
#  df_copub <- pluck(abm_public_kth$units, params$unit_code, 5)
#  df_oa <- pluck(abm_public_kth$units, params$unit_code, "oa")
#  df_woscov <- pluck(abm_public_kth$units, params$unit_code, "coverage")
#  unit_meta <- filter(abm_public_kth$meta, unit_code == params$unit_code)
#}

unit_level<- 2
#unit_level <- abm_public_kth$meta %>% 
#  filter(unit_code == params$unit_code) %>%
#  pull(org_level)

#if(isTRUE(unit_level >= 0)){
#  
#  unit_label <- 
#    abm_public_kth$meta %>% 
#    filter(unit_code == params$unit_code) %>%
#    pull(unit_long_en)
#  
#} else {
  
#  unit_label <- 
#    ad_displayname2(kthid = params$unit_code)
#}

#unit_label <- paste0("Annual Bibliometric Monitoring: ", unit_label)
unit_label <- unit_code
unit_file_label<- "Test"
abm_unit_title<- "Test"



current_date <- format(Sys.Date(), "%Y%m%d")

#abm_unit_title<- paste0("ABM: ",unit_label)

# TODO: change to suitable location for static PDF assets (or other non-HTML resources)
STATIC <- "https://kth-library.github.io/abm"

```

Publications in DiVA
=====================================
  
#### `r unit_label`
  
Row
---------------------
  
### **Publication volume, fractionalized** {.no-padding .no-mobile}
  
<!-- <div style='width:720px;margin:auto'> -->
  
<style type="text/css">
div.dt-buttons {
  position:relative;
  float:right;
}
</style>
  
```{r, fig.width=3.75}

abm_ui_datatable_diva(
  df_diva, 
  unit_file_label = unit_file_label, 
  unit_title = abm_unit_title
)

```
<!-- </div> -->
  
### **Publication volume, fractionalized** {.no-padding .mobile}
  
```{r, fig.width=3.75}
abm_ui_kable_diva(df_diva)
```


Row
---------------------
  
### **Publication volume** {.no-padding .no-mobile}
  
```{r, fig.width=8, fig.height=5}
if (nrow(df_diva) > 0) {
  p <- abm_graph_diva(df_diva)
  p
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
```

### **Publication volume** {.no-padding .mobile}

```{r, fig.width=8, fig.height = 5}
if (nrow(df_diva) > 0) {
  p
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
``` 

### **Web of Science coverage by publication type** {.no-padding .no-mobile}

```{r, fig.width=3, fig.height=5}
if (nrow(df_diva) > 0) {
  p <- abm_graph_wos_coverage(df_diva)
  p
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
```

### **Web of Science coverage by publication type** {.no-padding .mobile}

```{r, fig.width=3, fig.height=5}
if (nrow(df_diva) > 0) {
  p
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
```


Citation impact
=====================================

#### `r unit_label`

Row
---------------------

### **Citations 3-year window, fractional counts** {.no-mobile}

<style type="text/css">
div.dt-buttons {
  position:relative;
  float:right;
}
</style>
```{r}
abm_ui_datatable_city3y(
  df_cit3y, 
  unit_file_label = unit_file_label, 
  unit_title = abm_unit_title
)
```

### **Citations 3-year window, fractional counts** {.mobile}

```{r}
abm_ui_kable_cit3y(df_cit3y)
```

### **Field normalized citations, fractionalized (3-year moving average)** {.no-mobile}

<style type="text/css">
div.dt-buttons {
  position:relative;
  float:right;
}
</style>

```{r}
abm_ui_datatable_cf(
  df_cf,
  unit_file_label = unit_file_label, 
  unit_title = abm_unit_title
)
```

### **Field normalized citations, fractionalized (3-year moving average)** {.no-padding .mobile}

```{r}
abm_ui_kable_cf(df_cf)
```


Row
--------------------

### **Notes** [<i class="fa fa-info-circle" aria-hidden="true"></i> more...](`r STATIC`/ABM_guide.pdf){target="_blank" style="position:relative;float:right;"}

```{r, echo=FALSE, results="asis"}
cat("This table is based on Web of Science publication types Article, Proceedings paper, Review, Letter and Editorial.<br>")

if(isTRUE(unit_level >= 0)){

  years <- df_cit3y %>% filter(substr(Publication_Year_ch, 1, 1) == "2") %>% pull(Publication_Year_ch) %>% as.integer()
  mincov <- df_woscov %>% filter(Publication_Type == "Peer reviewed" & Publication_Year %in% years) %>% pull(woscov_frac) %>% min()
  minpubs <- df_woscov %>% filter(Publication_Type == "Peer reviewed" & Publication_Year %in% years) %>% pull(sumcov_full) %>% min()

  cat(glue("<span title='Legend: 75% or above is good, 60% or above is moderate while lower than 60% is poor'>Rows are based on at least <b>{minpubs}</b> (full counted) publications with ",
           "<b>{coveragetext(mincov)}</b> Web of Science coverage (at least <b>{round(100*mincov, 1)}%</b>).<br>",
           "(DiVA publication types Article, peer review and Conference paper, peer review)<br></span>"))

  if(minpubs < 50)
    cat("<b>Indicators based on < 50 publications are considered unreliable</b>")

} else {

  cat("<b>Bibliometric results for individual researchers should always be interpreted with caution.</b>")

}


```

### **Notes** [<i class="fa fa-info-circle" aria-hidden="true"></i> more...](`r STATIC`/ABM_guide.pdf){target="_blank" style="position:relative;float:right;"}

```{r, echo=FALSE, results="asis"}
cat("This table is based on Web of Science publication types Article and Review.<br>")

if(isTRUE(unit_level >= 0)){

  intervals <- df_cf %>% filter(substr(interval, 1, 1) == "2") %>% pull(interval)
  woscov_cf <- df_woscov %>%
    filter(Publication_Type == "Article, peer review")
  woscov_cf <- woscov_cf %>% 
    inner_join(sliding_intervals(min(woscov_cf$Publication_Year), max(woscov_cf$Publication_Year), 3), by = c("Publication_Year" = "x")) %>%
    filter(interval %in% intervals) %>%
    group_by(interval) %>% 
    summarise(woscov_frac = sum(sumcov_frac) / sum(p_frac),
              sumcov_full = sum(sumcov_full))

  mincov <- min(woscov_cf$woscov_frac)
  minpubs <- min(woscov_cf$sumcov_full)

  cat(glue("<span title='Legend: 75% or above is good, 60% or above is moderate while lower than 60% is poor'>Rows are based on at least <b>{minpubs}</b> (full counted) publications with ",
           "<b>{coveragetext(mincov)}</b> Web of Science coverage (at least <b>{round(100*mincov, 1)}%</b>).<br>",
           "(DiVA publication type Article, peer review)<br></span>"))

  if(minpubs < 50)
    cat("<b>Indicators based on < 50 publications are considered unreliable</b>")

} else {

  cat("<b>Bibliometric results for individual researchers should always be interpreted with caution.</b>")

}
```

Row
---------------------

### **Average field normalized citations (Cf)**

```{r}
if (df_cf %>% filter(!is.na(P_frac)) %>% nrow() > 0){
  abm_graph_cf(df_cf)
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
```


### **Share of publications among Top 10% cited**

```{r}
if (df_cf %>% filter(!is.na(P_frac)) %>% nrow() > 0){
  abm_graph_top10(df_cf)
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
```

Journal impact
=====================================

#### `r unit_label`

Row
---------------------

### **Journal impact, fractionalized (3-year moving average)** {.no-mobile}

<style type="text/css">
div.dt-buttons {
  position:relative;
  float:right;
}
</style>

```{r}
abm_ui_datatable_jcf(
  df_jcf,
  unit_file_label = unit_file_label, 
  unit_title = abm_unit_title
)
```

### **Journal impact, fractionalized (3-year moving average)** {.no-padding .mobile}

```{r, fig.width=3.75}
abm_ui_kable_jcf(df_jcf)
```

Row
-----------------

### **Notes** [<i class="fa fa-info-circle" aria-hidden="true"></i> more...](`r STATIC`/ABM_guide.pdf){target="_blank" style="position:relative;float:right;"}

```{r, echo=FALSE, results="asis"}
cat("This table is based on Web of Science publication types Article and Review.<br>")

if(isTRUE(unit_level >= 0)){
  intervals <- df_jcf %>% filter(substr(interval, 1, 1) == "2") %>% pull(interval)
  woscov_jcf <- df_woscov %>%
    filter(Publication_Type == "Article, peer review")
  woscov_jcf <- woscov_jcf %>% 
    inner_join(sliding_intervals(min(woscov_jcf$Publication_Year), max(woscov_jcf$Publication_Year), 3), by = c("Publication_Year" = "x")) %>%
    filter(interval %in% intervals) %>%
    group_by(interval) %>% 
    summarise(woscov_frac = sum(sumcov_frac) / sum(p_frac),
              sumcov_full = sum(sumcov_full))

  mincov <- min(woscov_jcf$woscov_frac)
  minpubs <- min(woscov_jcf$sumcov_full)

  cat(glue("<span title='Legend: 75% or above is good, 60% or above is moderate while lower than 60% is poor'>Rows are based on at least <b>{minpubs}</b> (full counted) publications with ",
           "<b>{coveragetext(mincov)}</b> Web of Science coverage (at least <b>{round(100*mincov, 1)}%</b>).<br>",
           "(DiVA publication type Article, peer review)<br></span>"))

  if(minpubs < 50)
    cat("<b>Indicators based on < 50 publications are considered unreliable</b>")

} else {

  cat("<b>Bibliometric results for individual researchers should always be interpreted with caution.</b>")

}
```

Row
---------------------

### **Field normalized journal impact (JCf)**

```{r}
if(df_jcf %>% filter(!is.na(P_frac)) %>% nrow() > 0) {
  abm_graph_jcf(df_jcf)
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
```


### **Share of publications in Top 20% journals**

```{r}
if(df_cf %>% filter(!is.na(P_frac)) %>% nrow() > 0) {
  abm_graph_top20(df_jcf)
} else {
  shiny::HTML("<p><i>There are no publications available for this graph</i></p>")
}
```



Blank
=====================================
